<?php if (!defined('BASEPATH')) exit('No direct script access allowed');

class Card extends CI_Controller {	var $curl_handle;	var $curl_options;	var $tmp_fname;	var $app_token;

	function __construct() {
		parent::__construct();				//Allow querystrings for this constructor		parse_str($_SERVER['QUERY_STRING'],$_GET);		
		//$this->auth->is_logged_in();		$this->tmp_fname = tempnam("/tmp", "CURLCOOKIE");		$this->curl_options = array(		//CURLOPT_COOKIESESSION => true,		//CURLOPT_COOKIEJAR => $tmp_fname,				CURLOPT_COOKIEFILE => $this->tmp_fname,				//CURLOPT_FRESH_CONNECT => false,		//CURLOPT_TIMEOUT_MS => 1, // timeout milliseconds on response		//CURLOPT_TIMEOUT => 300, // timeout on response				CURLOPT_RETURNTRANSFER => true, // return web page				CURLOPT_HEADER => false, // return headers				//CURLOPT_FOLLOWLOCATION => true, // follow redirects		//CURLOPT_SSL_VERIFYPEER => false,		//CURLOPT_ENCODING => "gzip,deflate,sdch", // handle all encodings				CURLOPT_USERAGENT => "merrymarry_web", // who am i				CURLOPT_HTTPHEADER => array('Content-Type: application/json', 'Connection: keep-alive'),				//CURLOPT_AUTOREFERER => true, // set referer on redirect		//CURLOPT_CONNECTTIMEOUT => 0, // timeout on connect		//CURLOPT_MAXREDIRS => 10, // stop after 10 redirects				CURLOPT_POST => true		);				$this->curl_handle = curl_init("http://api.merrymarry.me/TransactionProvider.aspx");		curl_setopt_array($this->curl_handle, $this->curl_options);		curl_setopt($this->curl_handle, CURLOPT_COOKIEJAR, $this->tmp_fname);		date_default_timezone_set('UTC');				$array_req_data = array(				'datas'=>array(						'reqName'=>'RefreshSession',						'reqData'=>json_encode(array('data'=>'none'))				)		);		$json_req_data = json_encode($array_req_data);		curl_setopt($this->curl_handle, CURLOPT_POSTFIELDS, $json_req_data);		//$this->curl_handle->post($json_req_data);		//$json_res_data =  $this->curl_handle->execute();		$json_res_data = curl_exec($this->curl_handle);		$array_res_data = json_decode($json_res_data);				//$data['mmares'] = $json_res_data;		//$data['mmaresinfo'] = curl_getinfo($this->curl_handle);				if ($array_res_data->d->msgCode != '999') {			show_error($array_res_data->d->msgContext);		}				$APPLICATION_ID = $this->config->item('appId');//$this->facebook->appId;		$APPLICATION_SECRET = $this->config->item('secret');//$this->facebook->secret;		$this->app_token = $this->get_app_access($APPLICATION_ID,$APPLICATION_SECRET);
	}
	function index() {
		//$this->load->model('fizzlebizzle');
		//$result = $this->fizzlebizzle->get_access_token();
		
		/*		if ($result['is_true']) {
			$this->session->set_userdata(array('access_token' => $result['access_token']));
		} else {
			$this->session->set_userdata(array('access_token' => FALSE));
		}		*/				$eventId = NULL;		$regDate = NULL;				if(isset($_GET['request_ids'])) {			$signed_request = $this->input->get('request_ids');						$this->load->model('fizzlebizzle');			$resultUser = $this->fizzlebizzle->get_user();						/*			 * Get the current user, you may use the PHP-SDK			* or your own server-side flow implementation			*/			$user = $this->getUserFromSignedRequest();						if($resultUser['is_true']) {				//$user = $resultUser['facebook_uid'];			}					// We may have more than one request, so it's better to loop			$requests = explode(',', $signed_request);			foreach($requests as $request_id) {				$userpos = strpos($request_id, '_');				// If we have an authenticated user, this would return a recipient specific request: <request_id>_<recipient_id>				if($user && $userpos !== false) {					$request_id = $request_id . "_{$user}";				}						// Get the request details using Graph API				$request_content = json_decode(file_get_contents("https://graph.facebook.com/$request_id?$this->app_token"), TRUE);				//echo "https://graph.facebook.com/$request_id?$this->app_token";							// An example of how to get info from the previous call				$request_message = $request_content['message'];				$from_id = $request_content['from']['id'];							// An easier way to extract info from the data field				extract(json_decode($request_content['data'], TRUE));				// Now that we got the $item_id and the $item_type, process them				// Or if the recevier is not yet a member, encourage him to claims his item (install your application)!				//echo $item_id;				$regDate = empty($regDate) ? $regData : $regDate;								//$eventId = '100001374129716&100002993798580';				//$regDate = '2012-06-18T10:10:36.389Z';								$application_data = $request_content['application'];							if($user) {					/*					 * When all is done, delete the requests because Facebook will not do it for you!					* But first make sure we have a user (OR access_token - not used here)					* because you can't delete a "general" request, you can only delete a recipient specific request					* <request_id>_<recipient_id>					*/					//$deleted = file_get_contents("https://graph.facebook.com/$request_id?$this->app_token&method=delete"); // Should return true on success				}				// Just one time.				break;			}		} else {			$eventId = '100001374129716&100002993798580';			$regDate = '2012-06-18T10:10:36.389Z';		}				// to __construct().				$this->load->library('awslib');		$sqs = new AmazonSQS();		$response = $sqs->list_queues();		//var_dump($response->isOK());		$data['awsobj'] = $response;				//curl_close($this->curl_handle);				$fh = fopen($this->tmp_fname, 'r');		$fh_size = filesize($this->tmp_fname);		if ($fh_size > 0) {			$theData = fread($fh, filesize($this->tmp_fname));			$data['mmasess'] = $theData;		}		fclose($fh);				//$this->curl_handle = curl_init("http://api.merrymarry.me/TransactionProvider.aspx");		//curl_setopt_array($this->curl_handle, $this->curl_options);		$array_req_data = array(				'datas'=>array(						'reqName'=>'GetWeddingEvent',						'reqData'=>json_encode(array('eventId'=>urldecode($eventId), 'regDate'=>urldecode($regDate)))						)				);				$json_req_data = json_encode($array_req_data);		curl_setopt($this->curl_handle, CURLOPT_POSTFIELDS, $json_req_data);		$json_res_data =  curl_exec($this->curl_handle);		if (!$json_res_data) {			$array_res_data = $this->curl_handle->debug();		} else {			$array_res_data = json_decode($json_res_data);		}				if ($array_res_data->d->msgCode != '12') {			show_error($array_res_data->d->msgContext);		}				$data['invite_data'] = $array_res_data->d->resData;		$data['invite_datainfo'] = $json_req_data;				$locationArray = explode('/', $array_res_data->d->resData->weddingEvent->where);		$locationInfo = Array();		if (count($locationArray) == 3) {			$locationInfo['lat'] = $locationArray[0];			$locationInfo['lon'] = $locationArray[1];			$locationInfo['add'] = $locationArray[2];		}		$data['invite_loc_data'] = $locationInfo;				curl_close($this->curl_handle);				$data['invite_rsvp_url'] = "card/rsvp/?eventId=" . urlencode($eventId) . "&regDate=" . urlencode($regDate);		$data['invite_rsvp_accept'] = "https://apps.facebook.com/${application_data['id']}/?request_ids=$request_id";				$data['gift_data'] = $array_res_data->d->resData->weddingEvent->gifts;
		$data['page'] = 'card_invite_view';
		$this->load->view('template', $data);
	}		function rsvp() {		$this->load->library('session');		$this->load->model('fizzlebizzle');		$resultUser = $this->fizzlebizzle->get_user();				/*		 * Get the current user, you may use the PHP-SDK		* or your own server-side flow implementation		*/		$user = $this->getUserFromSignedRequest();				$eventId = NULL;		$regDate = NULL;		$status = NULL;				if ($this->input->get('eventId')) {			$eventId = $this->input->get('eventId');			$regDate = $this->input->get('regDate');			$status = $this->input->get('status');		} elseif ($this->session->userdata('eventId')) {			$eventId = $this->session->userdata('eventId');			$regDate = $this->session->userdata('regDate');			$status = $this->session->userdata('status');			$sess_data = array(					'eventId' => '',					'regDate' => '',					'status' => ''			);			$this->session->unset_userdata($sess_data);		} else {			show_404();		}				$hosts = strstr($eventId, '&', true);				if($resultUser['is_true']) {			$user = $resultUser['facebook_uid'];		} else {			$sess_data = array(					'eventId' => $eventId,					'regDate' => $regDate,					'status' => $status			);			$this->session->set_userdata($sess_data);									echo("<script> top.location.href='" . $this->facebook->getLoginURL($this->config->item('facebook_login_parameters')) . "'</script>");			return;		}				$array_req_data = array(				'datas'=>array(						'reqName'=>'UpdateRSVP',						'reqData'=>json_encode(array(								'eventId'=>urldecode($eventId), 								'regDate'=>urldecode($regDate),								'responsor'=>urldecode($user),								'hosts'=>array(urldecode($hosts)),								'status' => $status,								'confirm' => '1'))				)		);				$json_req_data = json_encode($array_req_data);		curl_setopt($this->curl_handle, CURLOPT_POSTFIELDS, $json_req_data);		$json_res_data =  curl_exec($this->curl_handle);		if (!$json_res_data) {			$array_res_data = $this->curl_handle->debug();		} else {			$array_res_data = json_decode($json_res_data);		}				if ($array_res_data->d->msgCode != '33') {			show_error($array_res_data->d->msgContext);		}				$array_req_data = array(				'datas'=>array(						'reqName'=>'GetWeddingEvent',						'reqData'=>json_encode(array('eventId'=>urldecode($eventId), 'regDate'=>urldecode($regDate)))						)				);				$json_req_data = json_encode($array_req_data);		curl_setopt($this->curl_handle, CURLOPT_POSTFIELDS, $json_req_data);		$json_res_data =  curl_exec($this->curl_handle);		if (!$json_res_data) {			$array_res_data = $this->curl_handle->debug();		} else {			$array_res_data = json_decode($json_res_data);		}				if ($array_res_data->d->msgCode != '12') {			show_error($array_res_data->d->msgContext);		}				$data['invite_data'] = $array_res_data->d->resData;		$data['invite_datainfo'] = $json_req_data;				$locationArray = explode('/', $array_res_data->d->resData->weddingEvent->where);		$locationInfo = Array();		if (count($locationArray) == 3) {			$locationInfo['lat'] = $locationArray[0];			$locationInfo['lon'] = $locationArray[1];			$locationInfo['add'] = $locationArray[2];		}		$data['invite_loc_data'] = $locationInfo;				curl_close($this->curl_handle);				$data['gift_data'] = $array_res_data->d->resData->weddingEvent->gifts;		$data['page'] = 'card_invite_view';		$this->load->view('template', $data);	}
	//some example functions
	//function me is DRY and dynamic to show as example
	//object: likes, home, feed, movies, music, books, notes, permissions, photos, albums, videos, uploaded, events, groups, checkins, locations, etc.
	//https://developers.facebook.com/docs/reference/api/
	function me($object = NULL) {
		if ($object == NULL) {
			$this->index();
		} else {
			$this->load->model('fizzlebizzle');
			$result = $this->fizzlebizzle->get_facebook_object($object, $this->session->userdata('facebook_uid'), $this->session->userdata('access_token'));
			
			if ($result['is_true']) {
				$data['objects'] = $result['data'];
			} else {
				$data['error_message'] = $result['message'];
				$data['objects'] = array();
			}
			
			$data['page'] = 'objects_view';
			$this->load->view('template', $data);
		}
	}		function get_app_access($appId, $appSecret) {		$token_url =    "https://graph.facebook.com/oauth/access_token?" .				"client_id=" . $appId .				"&client_secret=" . $appSecret .				"&grant_type=client_credentials";		$token = file_get_contents($token_url);		return $token;	}		function getUserFromSignedRequest() {		if(isset($_GET['signed_request'])) {			$signed_request = $this->input->get('signed_request');			list($encoded_sig, $payload) = explode('.', $signed_request, 2);			$data = json_decode(base64_decode(strtr($payload, '-_', '+/')), true);				if( !empty($data['user_id']) )				return $data['user_id'];		}		return null;	}
}